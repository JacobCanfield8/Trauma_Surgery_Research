<!DOCTYPE html>
<html>
<head>
    <title>RTcotomy ML</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            background-color: #e9ecef;
            font-family: 'Arial', sans-serif;
        }
        .container {
            margin-top: 50px;
            background-color: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            color: #dc3545;
            font-size: 2.5rem;
        }
        .nav-bar {
            background-color: #dc3545;
            padding: 10px 0;
            text-align: center;
            margin-bottom: 20px;
        }
        .nav-bar a {
            color: white;
            margin: 0 15px;
            text-decoration: none;
            font-size: 1.25rem;
        }
        .nav-bar a:hover {
            text-decoration: underline;
        }
        .instructions {
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 1rem;
            color: #721c24;
        }
        .form-group label {
            font-weight: bold;
        }
        .form-group input, .form-group select {
            border-radius: 5px;
            height: 45px;
            font-size: 1rem;
        }
        .section-header {
            margin-top: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #dc3545;
        }
        .btn-primary {
            background-color: #dc3545;
            border-color: #dc3545;
            font-size: 1.25rem;
            padding: 10px;
        }
        .btn-primary:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 5px;
            display: none;
            font-size: 1.25rem;
            text-align: center;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .qr-code {
            text-align: center;
            margin-top: 20px;
        }
        .qr-code img {
            max-width: 100%;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://www.ifsa.org/wp-content/uploads/2024/05/Cook-County-Trauma-Burn-Stroger-1024x566.png" alt="Trauma Surgery and Burn Unit" class="img-header">
            <h1><i class="fas fa-heartbeat"></i> RTcotomy ML</h1>
            <p class="lead">Predicting outcomes of resuscitative thoracotomy for trauma and critical care.</p>
        </div>
        <div class="nav-bar">
            <a href="/">Home</a>
            <a href="/about">About</a>
            <a href="/contact">Contact</a>
        </div>
        <div class="instructions">
            <p>Please select a Model Type and Data Type to reveal the remaining fields. If you select Logistic Regression you will also have to select a penalty. After you that you will be provided several fields to input data. Once you have provided at least two data variables, a prediction can be made, but it should be noted that having more data fields filled in will lead to more reliable results and higher confidence in most instances (more information is always best). Confidence is a value that is equivalent to the assigned probability that the given model and parameters classified the outcome as its respective class (i.e. if the output is Deceased (Confidence: 75%), that would indicate that the machine learning model predicted the probability that this individual would expire if they were to receive a resuscitative thoracotomy within the first 20 minutes of arrival to the ED). Just to reiterate, in order to facilitate predictions in the absence of all of the input parameter, a separate model is trained for each combination of vitals, therefore the datafields you input inherently change the model being used, hence more input data results in a more reliable prediction both statistically and also in meaningfullness.</p>
        </div>
        <hr>
        <form id="predictionForm">
            <div class="form-group">
                <label for="VERSION">Model Version:</label>
                <select id="VERSION" name="VERSION" class="form-control" required>
                    <option value="">Select</option>
                    <option value="v0.0">v0.0</option>
                    <option value="v1.0">v1.0</option>
                    <option value="v2.0">v2.0</option>
                </select>
            </div>
            <div class="section-header">Machine Learning Model Parameters and Data Features</div>
            <div class="form-group">
                <label for="MODEL_TYPE">Model Type:</label>
                <select id="MODEL_TYPE" name="MODEL_TYPE" class="form-control" required>
                    <option value="">Select</option>
                    <option value="xgb">XGBoost</option>
                    <option value="logistic_regression">Logistic Regression</option>
                </select>
            </div>
            <div class="form-group" id="penalty-group" style="display: none;">
                <label for="PENALTY">Penalty (for Logistic Regression):</label>
                <select id="PENALTY" name="PENALTY" class="form-control">
                    <option value="">Select</option>
                    <option value="l1">LASSO</option>
                    <option value="l2">RIDGE</option>
                    <option value="elasticnet">Elastic Net</option>
                </select>
            </div>
            <div class="form-group" id="data-type-group">
                <label for="DATA_TYPE">Data Type:</label>
                <select id="DATA_TYPE" name="DATA_TYPE" class="form-control" required>
                    <option value="">Select</option>
                    <option value="EMS">EMS</option>
                    <option value="ED">ED</option>
                    <option value="EMS + ED">EMS + ED</option>
                </select>
            </div>

            <!-- Form Fields -->
            <div id="form-fields" class="hidden">
                <div class="section-header">Trauma and Injury Info</div>
                <div class="form-group">
                    <label for="TRAUMATYPE">Trauma Type:</label>
                    <select id="TRAUMATYPE" name="TRAUMATYPE" class="form-control">
                        <option value="">Select</option>
                        <option value="Blunt">Blunt</option>
                        <option value="Penetrating">Penetrating</option>
                        <option value="Burn">Burn</option>
                        <option value="Other/unspecified">Other/unspecified</option>
                    </select>
                </div>
                <div class="form-group" id="mechanism-group">
                    <label for="MECHANISM">Mechanism:</label>
                    <select id="MECHANISM" name="MECHANISM" class="form-control">
                        <option value="">Select</option>
                        <option value="0">MVT Occupant</option>
                        <option value="1">MVT Pedestrian</option>
                        <option value="2">Firearm</option>
                        <option value="3">Cut/pierce</option>
                        <option value="4">MVT Motorcyclist</option>
                        <option value="5">Transport, other</option>
                        <option value="6">Unspecified</option>
                        <option value="7">Fall</option>
                        <option value="8">Other specified and classifiable</option>
                        <option value="9">Machinery</option>
                        <option value="10">Struck by, against</option>
                        <option value="11">Natural/environmental, Other</option>
                        <option value="12">Pedal cyclist, other</option>
                        <option value="13">MVT Unspecified</option>
                        <option value="14">MVT Pedal cyclist</option>
                        <option value="15">Pedestrian, other</option>
                        <option value="16">Unknown</option>
                        <option value="17">MVT Other</option>
                        <option value="18">Other specified, not elsewhere classifiable</option>
                        <option value="19">Poisoning</option>
                        <option value="20">Adverse effects, medical care</option>
                        <option value="21">Fire/flame</option>
                        <option value="22">Suffocation</option>
                        <option value="23">Natural/environmental, Bites and stings</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="PREHOSPITALCARDIACARREST">Prehospital Cardiac Arrest:</label>
                    <select id="PREHOSPITALCARDIACARREST" name="PREHOSPITALCARDIACARREST" class="form-control">
                        <option value="">Select</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>

                <div class="section-header">Patient Demographics</div>
                <div class="form-group">
                    <label for="SEX">Sex:</label>
                    <select id="SEX" name="SEX" class="form-control">
                        <option value="">Select</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="AGEYEARS">Age (Years):</label>
                    <input type="number" id="AGEYEARS" name="AGEYEARS" class="form-control" value="">
                </div>

                <div class="section-header">Vital Signs and GCS</div>
                <div id="vitals">
                    <!-- EMS fields -->
                    <div class="form-group EMS hidden">
                        <label for="EMSSBP">EMS Systolic Blood Pressure (SBP):</label>
                        <input type="number" id="EMSSBP" name="EMSSBP" class="form-control" value="">
                    </div>
                    <div class="form-group EMS hidden">
                        <label for="EMSPULSERATE">EMS Pulse Rate:</label>
                        <input type="number" id="EMSPULSERATE" name="EMSPULSERATE" class="form-control" value="">
                    </div>
                    <div class="form-group EMS hidden">
                        <label for="EMSRESPIRATORYRATE">EMS Respiratory Rate:</label>
                        <input type="number" id="EMSRESPIRATORYRATE" name="EMSRESPIRATORYRATE" class="form-control" value="">
                    </div>
                    <div class="form-group EMS hidden">
                        <label for="EMSTOTALGCS">EMS Total Glasgow Coma Scale (GCS):</label>
                        <input type="number" id="EMSTOTALGCS" name="EMSTOTALGCS" class="form-control" value="">
                    </div>

                    <!-- ED fields -->
                    <div class="form-group ED hidden">
                        <label for="SBP">Systolic Blood Pressure (SBP):</label>
                        <input type="number" id="SBP" name="SBP" class="form-control" value="">
                    </div>
                    <div class="form-group ED hidden">
                        <label for="PULSERATE">Pulse Rate:</label>
                        <input type="number" id="PULSERATE" name="PULSERATE" class="form-control" value="">
                    </div>
                    <div class="form-group ED hidden">
                        <label for="RESPIRATORYRATE">Respiratory Rate:</label>
                        <input type="number" id="RESPIRATORYRATE" name="RESPIRATORYRATE" class="form-control" value="">
                    </div>
                    <div class="form-group ED hidden">
                        <label for="TOTALGCS">Total Glasgow Coma Scale (GCS):</label>
                        <input type="number" id="TOTALGCS" name="TOTALGCS" class="form-control" value="">
                    </div>
                    <div class="form-group ED hidden">
                        <label for="TEMPERATURE">Temperature (C):</label>
                        <input type="number" id="TEMPERATURE" name="TEMPERATURE" class="form-control" value="">
                    </div>

                    <!-- EMS + ED fields -->
                    <div class="row EMS_ED hidden">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="EMSSBP">EMS Systolic Blood Pressure (SBP):</label>
                                <input type="number" id="EMSSBP" name="EMSSBP" class="form-control" value="">
                            </div>
                            <div class="form-group">
                                <label for="EMSPULSERATE">EMS Pulse Rate:</label>
                                <input type="number" id="EMSPULSERATE" name="EMSPULSERATE" class="form-control" value="">
                            </div>
                            <div class="form-group">
                                <label for="EMSTOTALGCS">EMS Total Glasgow Coma Scale (GCS):</label>
                                <input type="number" id="EMSTOTALGCS" name="EMSTOTALGCS" class="form-control" value="">
                            </div>
                            <div class="form-group">
                                <label for="EMSRESPIRATORYRATE">EMS Respiratory Rate:</label>
                                <input type="number" id="EMSRESPIRATORYRATE" name="EMSRESPIRATORYRATE" class="form-control" value="">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="SBP">Systolic Blood Pressure (SBP):</label>
                                <input type="number" id="SBP" name="SBP" class="form-control" value="">
                            </div>
                            <div class="form-group">
                                <label for="PULSERATE">Pulse Rate:</label>
                                <input type="number" id="PULSERATE" name="PULSERATE" class="form-control" value="">
                            </div>
                            <div class="form-group">
                                <label for="TOTALGCS">Total Glasgow Coma Scale (GCS):</label>
                                <input type="number" id="TOTALGCS" name="TOTALGCS" class="form-control" value="">
                            </div>
                            <div class="form-group">
                                <label for="RESPIRATORYRATE">Respiratory Rate:</label>
                                <input type="number" id="RESPIRATORYRATE" name="RESPIRATORYRATE" class="form-control" value="">
                            </div>
                            <div class="form-group">
                                <label for="TEMPERATURE">Temperature (C):</label>
                                <input type="number" id="TEMPERATURE" name="TEMPERATURE" class="form-control" value="">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-block hidden"><i class="fas fa-stethoscope"></i> Predict</button>
        </form>
        <div class="result alert" id="result"></div>
        <div class="qr-code">
            <h2>Scan the QR code to visit the website:</h2>
            <img src="/generate_qr" alt="QR Code">
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function() {
            function updateFormFields() {
                const selectedType = $('#DATA_TYPE').val();
                $('.form-group.ED, .form-group.EMS, .row.EMS_ED').addClass('hidden');
                if (selectedType === 'EMS') {
                    $('.form-group.EMS').removeClass('hidden');
                } else if (selectedType === 'ED') {
                    $('.form-group.ED').removeClass('hidden');
                } else if (selectedType === 'EMS + ED') {
                    $('.row.EMS_ED').removeClass('hidden');
                }
            }

            function checkFormFields() {
                const selectedVersion = $('#VERSION').val();
                if (selectedVersion === 'v0.0') {
                    $('#data-type-group select').html('<option value="EMS">EMS</option>');
                    $('#mechanism-group').hide();
                } else {
                    $('#data-type-group select').html(`
                        <option value="">Select</option>
                        <option value="EMS">EMS</option>
                        <option value="ED">ED</option>
                        <option value="EMS + ED">EMS + ED</option>
                    `);
                    $('#mechanism-group').show();
                }

                if ($('#MODEL_TYPE').val() && ($('#MODEL_TYPE').val() !== 'logistic_regression' || $('#PENALTY').val()) && ($('#DATA_TYPE').val() || selectedVersion === 'v0.0') && selectedVersion) {
                    $('#form-fields, .btn-primary').removeClass('hidden');
                } else {
                    $('#form-fields, .btn-primary').addClass('hidden');
                }
            }

            $('#MODEL_TYPE').on('change', function() {
                if ($(this).val() === 'logistic_regression') {
                    $('#penalty-group').show();
                } else {
                    $('#penalty-group').hide();
                }
                checkFormFields();
            });

            $('#PENALTY, #DATA_TYPE, #VERSION').on('change', function() {
                checkFormFields();
                updateFormFields();
            });

            checkFormFields(); // Ensure correct fields are shown on initial load

            $('#predictionForm').on('submit', function(event) {
                event.preventDefault();
                var formData = $(this).serialize();
                $.ajax({
                    url: '/predict',
                    method: 'POST',
                    data: formData,
                    success: function(response) {
                        var resultDiv = $('#result');
                        if (response.error) {
                            resultDiv.text(response.error);
                            resultDiv.removeClass('alert-success').addClass('alert-danger');
                        } else {
                            resultDiv.html(response.result + " (Confidence: " + response.confidence.toFixed(2) + "%)");
                            if (response.result === 'Survived') {
                                resultDiv.removeClass('alert-danger').addClass('alert-success');
                            } else {
                                resultDiv.removeClass('alert-success').addClass('alert-danger');
                            }
                        }
                        resultDiv.show();
                    },
                    error: function() {
                        $('#result').text('An error occurred while processing your request.').removeClass('alert-success').addClass('alert-danger').show();
                    }
                });
            });
        });
    </script>
</body>
</html>
